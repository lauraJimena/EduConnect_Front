@using EduConnect_Front.Dtos
@model EduConnect_Front.Dtos.SolicitudTutoriaRespuestaDto

@{
    ViewData["Title"] = "Solicitud de Tutoría";
    Layout = "_LayoutUsuario";
}

@section Styles {
    <link rel="stylesheet" href="~/estilos/formSolicitudTutoria.css" />
}

<main class="solicitud-container">
    <section class="form-section">
        <h1>SOLICITUD DE TUTORÍA</h1>

        <form asp-controller="Tutorado" asp-action="FormSolicitudTutoria" method="post" class="formulario-tutoria">
            @Html.AntiForgeryToken()

            <!-- 🔹 Campo oculto para el IdTutor -->
            <input type="hidden" asp-for="IdTutor" />
            <input type="hidden" asp-for="IdTutorado" />
            <input type="hidden" asp-for="IdMateria" />

            <label for="fecha">Fecha sugerida</label>
            <input type="date" id="fecha" name="Fecha" required />


            <label for="hora">Hora sugerida</label>
            <input type="time" id="hora" asp-for="Hora" id="hora" required />

            <label for="modalidad">Modalidad preferida</label>
            <select asp-for="IdModalidad" required>
                <option value="">MODALIDAD PREFERIDA</option>
                <option value="1">Presencial</option>
                <option value="2">Virtual</option>
            </select>

            <label for="tema">Tema que requieres</label>
            <input type="text" asp-for="Tema" placeholder="TEMA QUE REQUIERO" required />

            <label for="comentario">Comentario adicional (opcional)</label>
            <textarea asp-for="ComentarioAdicional" placeholder="COMENTARIO ADICIONAL"></textarea>

            <button type="submit" class="btn-enviar">ENVIAR</button>
        </form>
    </section>

   

</main>

<!-- 🔹 Popup de ÉXITO -->
@if (TempData["Success"] != null)
{
    @await Html.PartialAsync("_Popup", new PopupDto
    {
        Tipo = "exito",
        Titulo = "Solicitud enviada con éxito",
        Mensaje = TempData["Success"] as string
        })

<script>
    // Espera 2 segundos y redirige
    setTimeout(() => {
        window.location.href = '@Url.Action("BusquedaTutores", "Tutorado")';
    }, 7000);
</script>
        }

<!-- 🔹 Popup de ERROR -->
@if (TempData["Error"] != null)
{
    @await Html.PartialAsync("_Popup", new PopupDto
    {
        Tipo = "error",
        Titulo = "Error al enviar la solicitud",
        Mensaje = TempData["Error"] as string
        })
}
@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const fechaInput = document.getElementById("fecha");
            const horaInput = document.getElementById("hora");

            // 🔹 Establece la fecha mínima como hoy
            const hoy = new Date();
            const yyyy = hoy.getFullYear();
            const mm = String(hoy.getMonth() + 1).padStart(2, "0");
            const dd = String(hoy.getDate()).padStart(2, "0");
            const fechaMin = `${yyyy}-${mm}-${dd}`;
            fechaInput.min = fechaMin;

            // 🔹 Cuando el usuario cambia la fecha
            fechaInput.addEventListener("change", function () {
                const fechaSeleccionada = new Date(fechaInput.value);
                const hoy = new Date();

                // Si la fecha seleccionada es hoy → limitar hora
                if (
                    fechaSeleccionada.getFullYear() === hoy.getFullYear() &&
                    fechaSeleccionada.getMonth() === hoy.getMonth() &&
                    fechaSeleccionada.getDate() === hoy.getDate()
                ) {
                    const horaActual = hoy.getHours();
                    const minutosActuales = hoy.getMinutes();

                    // 🔹 Redondear a los próximos 5 minutos
                    const minutosRedondeados = Math.ceil(minutosActuales / 5) * 5;
                    const horaMin = `${String(horaActual).padStart(2, "0")}:${String(minutosRedondeados).padStart(2, "0")}`;
                    horaInput.min = horaMin;
                    horaInput.disabled = false;
                }
                else {
                    // Si es una fecha futura → habilitar desde medianoche
                    horaInput.min = "00:00";
                    horaInput.disabled = false;
                }
            });

            // 🔹 Al cargar la página, deshabilitamos la hora hasta elegir fecha
            horaInput.disabled = true;
        });
    </script>
}
